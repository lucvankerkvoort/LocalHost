// Localhost Platform - Database Schema
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"

}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?
  name          String?
  image         String?
  languages     String[]  @default([])
  interests     String[]  @default([])
  
  // Host Profile
  bio           String?
  quote         String?
  responseTime  String?   @default("within a day") // e.g. "within an hour"
  isSyntheticHost Boolean @default(false)
  syntheticBotEnabled Boolean @default(false)
  syntheticPersonaKey String?
  syntheticResponseStyle SyntheticResponseStyle @default(FRIENDLY)
  syntheticResponseLatencyMinSec Int? @default(5)
  syntheticResponseLatencyMaxSec Int? @default(30)
  
  // Location
  city          String?
  country       String?
  
  // Verification
  isHost            Boolean @default(false)
  isVerified        Boolean @default(false)
  verificationTier  VerificationTier @default(BASIC)
  trustScore        Int     @default(0)
  
  // Stripe Connect
  stripeConnectedAccountId String?
  stripeOnboardingStatus   StripeOnboardingStatus @default(NOT_STARTED)
  payoutsEnabled           Boolean  @default(false)
  chargesEnabled           Boolean  @default(false)
  
  // Auth
  accounts      Account[]
  sessions      Session[]
  
  // Relations
  hostedExperiences Experience[] @relation("HostedExperiences")
  bookings          Booking[]    @relation("GuestBookings")
  hostBookings      Booking[]    @relation("HostBookings")
  syntheticReplyJobs SyntheticReplyJob[] @relation("HostSyntheticJobs")
  reviewsGiven      Review[]     @relation("ReviewerReviews")
  reviewsReceived   Review[]     @relation("RevieweeReviews")
  messagesSent      Message[]    @relation("SentMessages")
  trips             Trip[]
  experienceDrafts  ExperienceDraft[]
  hostExperience    HostExperience?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// EXPERIENCES
// ============================================

model Experience {
  id          String   @id @default(cuid())
  hostId      String
  host        User     @relation("HostedExperiences", fields: [hostId], references: [id], onDelete: Cascade)
  
  title       String
  description String   @db.Text
  category    ExperienceCategory
  
  // Location
  neighborhood String
  city         String
  country      String
  address      String?  // Revealed after booking
  latitude     Float?
  longitude    Float?
  
  // Details
  duration     Int      // in minutes
  minGroupSize Int      @default(1)
  maxGroupSize Int      @default(6)
  price        Int      // in cents
  currency     String   @default("USD")
  
  // What's included/excluded
  includedItems String[] @default([])
  excludedItems String[] @default([])
  
  // Media
  photos      String[] @default([])
  
  // Stats
  rating      Float    @default(0)
  reviewCount Int      @default(0)
  
  // Status
  isActive    Boolean  @default(true)
  
  // Relations
  bookings    Booking[]
  reviews     Review[]
  availability ExperienceAvailability[]
  itineraryItems ItineraryItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([hostId])
  @@index([category])
  @@index([city])
  @@index([isActive])
}

model ExperienceAvailability {
  id           String   @id @default(cuid())
  experienceId String
  experience   Experience @relation(fields: [experienceId], references: [id], onDelete: Cascade)
  
  date         DateTime
  startTime    String?  // "09:00"
  endTime      String?  // "12:00"
  spotsLeft    Int?     // Optional for date-only availability
  timezone     String?  // IANA TZ, e.g. "Europe/Rome"
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([experienceId, date])
}

// ============================================
// TRIPS & ITINERARY
// ============================================

model Trip {
  id          String     @id @default(cuid())
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  status      TripStatus @default(DRAFT)
  preferences Json       @default("{}")
  startDate   DateTime?
  endDate     DateTime?
  
  stops       TripStop[]
  bookings    Booking[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([userId])
}

model TripStop {
  id        String   @id @default(cuid())
  tripId    String
  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  
  country   String
  city      String
  lat       Float
  lng       Float
  order     Int
  
  days      ItineraryDay[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tripId, order])
}

model ItineraryDay {
  id         String   @id @default(cuid())
  tripStopId String
  tripStop   TripStop @relation(fields: [tripStopId], references: [id], onDelete: Cascade)
  
  dayIndex   Int
  date       DateTime?
  title      String?
  suggestedHosts Json?     @default("[]") // Store array of suggested hosts/experiences
  
  items      ItineraryItem[]
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([tripStopId, dayIndex])
}

model ItineraryItem {
  id           String            @id @default(cuid())
  dayId        String
  day          ItineraryDay      @relation(fields: [dayId], references: [id], onDelete: Cascade)
  
  type         ItineraryItemType
  title        String
  description  String?
  startTime    DateTime?
  endTime      DateTime?
  locationName String?
  lat          Float?
  lng          Float?
  
  experienceId String?
  experience   Experience?       @relation(fields: [experienceId], references: [id])
  hostId       String?           // Direct host reference for mock experiences
  
  orderIndex   Int
  createdByAI  Boolean           @default(true)
  isDeleted    Boolean           @default(false)
  
  bookings     Booking[]         @relation("ItemBookings")

  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@unique([dayId, orderIndex])
}

enum TripStatus {
  DRAFT
  PLANNED
  PARTIALLY_BOOKED
  BOOKED
  COMPLETED
}

enum ItineraryItemType {
  SIGHT
  EXPERIENCE
  MEAL
  FREE_TIME
  TRANSPORT
  NOTE
  LODGING
}

// ============================================
// BOOKINGS (Updated)
// ============================================

model Booking {
  id            String   @id @default(cuid())
  
  // Relations
  tripId        String?
  trip          Trip?    @relation(fields: [tripId], references: [id], onDelete: Cascade)
  
  experienceId  String
  experience    Experience @relation(fields: [experienceId], references: [id])
  
  guestId       String
  guest         User     @relation("GuestBookings", fields: [guestId], references: [id])
  
  // Denormalized Host ID for easier payouts
  hostId        String?
  host          User?    @relation("HostBookings", fields: [hostId], references: [id])
  
  itemId        String?
  itineraryItem ItineraryItem? @relation("ItemBookings", fields: [itemId], references: [id])
  
  // Details
  date          DateTime
  startTime     String?
  endTime       String?
  timezone      String?
  guests        Int
  
  totalPrice    Int      @default(0) // Re-added for backward compatibility
  amountSubtotal  Int    @default(0)
  platformFee     Int    @default(0)
  hostNetAmount   Int    @default(0)
  currency        String @default("USD")
  
  stripePaymentId String?
  stripeTransferId String?
  stripeRefundId   String?
  
  status        BookingStatus   @default(TENTATIVE)
  paymentStatus PaymentStatus   @default(PENDING)
  payoutStatus  PayoutStatus    @default(NOT_ELIGIBLE)
  payoutEligibleAt DateTime?
  
  // Features
  chatUnlocked  Boolean       @default(false)
  
  // Communication
  messages      Message[]
  syntheticReplyJobs SyntheticReplyJob[]
  
  // Reviews
  reviews       Review[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([experienceId])
  @@index([guestId])
  @@index([tripId])
  @@index([status])
}

// ============================================
// CHAT (Updated for Booking-centric flow)
// ============================================

model ChatThread {
  id            String   @id @default(cuid())
  
  // Linked to Booking (Tentative or Confirmed)
  bookingId     String   @unique
  // We can't link to Booking here directly *if* Booking already has `messages`. 
  // But the new design suggests ChatThread might be better than loose Messages.
  // For now, let's keep it simple: Messages can belong to Booking directly (as they did).
  // But if we want Thread metadata...
  
  // Wait, existing schema had Message linked to Booking.
  // The User's spec didn't mention ChatThread model, but I promised to persist Chat.
  // I will link ChatThread to Booking for now to enable the P2P features.
  // Actually, let's just use the Booking's messages relation for now to allow conversation
  // even if status is TENTATIVE.
}

// ============================================
// REVIEWS
// ============================================

model Review {
  id           String   @id @default(cuid())
  bookingId    String
  booking      Booking  @relation(fields: [bookingId], references: [id])
  experienceId String
  experience   Experience @relation(fields: [experienceId], references: [id])
  
  reviewerId   String
  reviewer     User     @relation("ReviewerReviews", fields: [reviewerId], references: [id])
  revieweeId   String
  reviewee     User     @relation("RevieweeReviews", fields: [revieweeId], references: [id])
  
  type         ReviewType
  rating       Int      // 1-5
  content      String   @db.Text
  
  createdAt    DateTime @default(now())
  
  @@index([experienceId])
  @@index([revieweeId])
}

// ============================================
// MESSAGING
// ============================================

model Message {
  id           String   @id @default(cuid())
  bookingId    String
  booking      Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  senderId     String
  sender       User     @relation("SentMessages", fields: [senderId], references: [id])
  triggeredSyntheticJobs SyntheticReplyJob[] @relation("TriggeredSyntheticJobs")
  
  content      String   @db.Text
  isRead       Boolean  @default(false)
  
  createdAt    DateTime @default(now())
  
  @@index([bookingId])
  @@index([senderId])
}

model SyntheticReplyJob {
  id               String   @id @default(cuid())
  bookingId        String
  booking          Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  hostId           String
  host             User     @relation("HostSyntheticJobs", fields: [hostId], references: [id], onDelete: Cascade)
  triggerMessageId String
  triggerMessage   Message  @relation("TriggeredSyntheticJobs", fields: [triggerMessageId], references: [id], onDelete: Cascade)
  status           SyntheticReplyJobStatus @default(PENDING)
  dueAt            DateTime
  attemptCount     Int      @default(0)
  error            String?  @db.Text
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([status, dueAt])
  @@index([bookingId])
  @@index([hostId])
  @@unique([bookingId, triggerMessageId])
}

// ============================================
// PAYMENT AUDIT
// ============================================

model PaymentEvent {
  id           String   @id @default(cuid())
  bookingId    String?
  type         String   // e.g. PAYMENT_INTENT_SUCCEEDED, TRANSFER_CREATED
  payload      Json
  createdAt    DateTime @default(now())
  
  @@index([bookingId])
}

// ============================================
// ENUMS
// ============================================

enum StripeOnboardingStatus {
  NOT_STARTED
  PENDING
  COMPLETE
  RESTRICTED
}

enum SyntheticResponseStyle {
  FRIENDLY
  PROFESSIONAL
  CONCISE
  WARM
}

enum SyntheticReplyJobStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
  CANCELLED
}

enum PayoutStatus {
  NOT_ELIGIBLE
  ELIGIBLE
  RELEASED
  BLOCKED
  REFUNDED
}

enum VerificationTier {
  BASIC     // Email verified
  VERIFIED  // ID + phone verified
  TRUSTED   // Background check + 10+ reviews
}

enum ExperienceCategory {
  FOOD_DRINK
  ARTS_CULTURE
  OUTDOOR_ADVENTURE
  WELLNESS
  LEARNING
  NIGHTLIFE_SOCIAL
  FAMILY
}

enum BookingStatus {
  TENTATIVE
  CONFIRMED
  CANCELLED
  COMPLETED
  PENDING // Keeping for backward compat if needed, but TENTATIVE is preferred
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

enum ReviewType {
  GUEST_TO_HOST
  HOST_TO_GUEST
}

// ============================================
// HOST EXPERIENCE CREATION
// ============================================

model ExperienceDraft {
  id          String   @id @default(cuid())
  userId      String   // Removed @unique to allow multiple drafts
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Location
  city        String?
  country     String?
  cityLat     Float?
  cityLng     Float?
  
  // Content (AI-generated, host-editable)
  title       String?
  shortDesc   String?  @db.Text  // Marketing-facing
  longDesc    String?  @db.Text  // Narrative description
  
  // Flexible sections for AI generation (e.g. house rules, amenities)
  sections    Json?    @default("{}")

  // Stops
  stops       ExperienceStop[] @relation("DraftStops")
  
  // Metadata
  duration    Int?     // Estimated minutes
  price       Int?     // Cents
  currency    String?  @default("USD")
  status      DraftStatus @default(IN_PROGRESS)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum DraftStatus {
  IN_PROGRESS
  AI_GENERATED
  READY_TO_PUBLISH
}

model ExperienceStop {
  id          String   @id @default(cuid())
  
  // Belongs to either draft or published experience
  draftId     String?
  draft       ExperienceDraft? @relation("DraftStops", fields: [draftId], references: [id], onDelete: Cascade)
  experienceId String?
  experience  HostExperience? @relation("ExperienceStops", fields: [experienceId], references: [id], onDelete: Cascade)
  
  // Stop details
  name        String
  description String?  @db.Text
  address     String?
  lat         Float?
  lng         Float?
  order       Int      @default(0)
  
  @@index([draftId])
  @@index([experienceId])
}

model HostExperience {
  id          String   @id @default(cuid())
  hostId      String   @unique  // Only one experience per host (MVP)
  host        User     @relation(fields: [hostId], references: [id], onDelete: Cascade)
  
  // Location
  city        String
  country     String
  
  // Content
  title       String
  shortDesc   String   @db.Text
  longDesc    String   @db.Text
  
  // Stops
  stops       ExperienceStop[] @relation("ExperienceStops")
  
  // Metadata
  duration    Int      // Minutes
  price       Int?     // Cents (optional for MVP)
  
  // Status
  status      HostExperienceStatus @default(PUBLISHED)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([city])
  @@index([status])
}

enum HostExperienceStatus {
  PUBLISHED
  UNPUBLISHED
  FLAGGED
}
